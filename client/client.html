<!DOCTYPE html>
<html lang="en">
<head>
  <title>IOU API</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  <link href="https://fonts.googleapis.com/css?family=Caveat|Lato" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">
    const handleResponse = (xhr, parseResponse) => {

      const content = document.querySelector('#content');
      content.innerHTML = "";
      
      //if its JSON
      if (xhr.status == 204){
        p.textContent = "Updated (no content)";
      }  else if(parseResponse){
          const obj = JSON.parse(xhr.response);
          if(obj.IOUs){
            console.log(JSON.stringify(obj.IOUs));
          const IOUs = obj.IOUs;
          for(var property in IOUs){
            const div = document.createElement('div')
            if(IOUs.hasOwnProperty(property)){
              let name = document.createElement('p');
              let otherName = document.createElement('p');
              let ammount = document.createElement('p');
              let why = document.createElement('p');
              let when = document.createElement('p');
              //console.log(property); //Ticket
              console.log(IOUs[property]); //Objcet on ticket
              //console.log(IOUs[property].name); //bob
              name.textContent = IOUs[property].name;
              otherName.textContent = "Owed by: " + IOUs[property].otherName;
              ammount.textContent = "$" + IOUs[property].ammount;
              why.textContent = "For: " +property;
              when.textContent = "Due by: " +IOUs[property].when;

              div.appendChild(name);
              div.appendChild(otherName);
              div.appendChild(ammount);
              div.appendChild(why);
              div.appendChild(when);
            }
            content.appendChild(div);
          }
          
          }
      } else {
        console.log('recieved');
      }
    };

    //function to send request
    const requestUpdate = (e, form) => {
      e.preventDefault();
      //grab url field 
      let url;
      if(form.querySelector('#urlField')){
        url = form.querySelector('#urlField').value;}
      else{
        url = '/addIOU';}
      
      let method;
      //grab method selected
      if(form.querySelector('#methodSelect')){
        method = form.querySelector('#methodSelect').value;
        
      }else {
        method = 'post';}
      //create a new AJAX request (asynchronous)
      const xhr = new XMLHttpRequest();
      //setup connect using the selected method and url
      console.log(url);
      xhr.open(method, url);
      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader('Accept', 'application/json');
      //if get request or head request
      if(method == 'get') {
        //set onload to parse request and get json message
        xhr.onload = () => handleResponse(xhr, true);
      } else if( method == 'post') {
        xhr.onload = () => handleResponse(xhr, true);
      } else if ( method == 'head'){
        xhr.onload = () => handleResponse(xhr, false);
      }
      const formData = `name=${nameField.value}
      &oname=${oNameField.value}&ammount=${ammountField.value}
      &when=${dateField.value}&why=${whyField.value}`;

      //send ajax request
      xhr.send(formData);
      //cancel browser's default action
     
      //return false to prevent page redirection from a form
      return false;
    };

    const init = () => {

      //for display

      //grab selects and button
      const moneyForm = document.querySelector('#moneyForm');
      const getForm = document.querySelector('#getForm');

      //function to handle our request
      const addIOUs = (e) => requestUpdate(e, moneyForm);
      const getIOUs = (e) => requestUpdate(e, getForm);
      
      //add event listener
      moneyForm.addEventListener('submit', addIOUs);
      getForm.addEventListener('submit', getIOUs)
    };

    window.onload = init;
  </script>
</head>
<body>
  <h2 id="title">IOU</h2>
  <section id="top">
    <form id="moneyForm" action="/addIOU" method="post">

      <div id="yourName">
      <label id="namelabel" for="name">Pay to the Order Of: </label>
      <input id="nameField" type="text" name="name" size=75/>
      </div>
      <label for="ammount">$: </label>
      <input id="ammountField" type="number" name="ammount" step="1" />

      <label for="when">Due By (optional): </label>
      <input id="dateField" type="date" name="date">

      <label for="why">For: </label>
      <input id="whyField" type="text" name = "why" size=35/>
 
      <label for="owesName">Signed: </label>
      <input  id="oNameField"  type="text" name="oName" size=25/>

      
      <input type="submit" value="Add IOU" />
    </form>
    <form id="getForm" action="/getIOUs" method="get">
      <select id='urlField'>
        <option selected value='/getIOUs'>/getIOUs</option>
      </select>
      <select id="methodSelect">
        <option selected value="get">GET</option>
      </select>
      <input type="submit" value="Get IOUs" />
    </form>
  </section>
  <section id="content">
  </section>
</body>
</html>


